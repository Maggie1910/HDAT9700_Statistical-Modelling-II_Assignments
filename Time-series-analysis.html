<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Maggie Burmeister">
<meta name="dcterms.date" content="2024-08-11">

<title>HDAT9700: Assessment 3 - Chapters 7-8</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="submission_files/libs/clipboard/clipboard.min.js"></script>
<script src="submission_files/libs/quarto-html/quarto.js"></script>
<script src="submission_files/libs/quarto-html/popper.min.js"></script>
<script src="submission_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="submission_files/libs/quarto-html/anchor.min.js"></script>
<link href="submission_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="submission_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="submission_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="submission_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="submission_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">HDAT9700: Assessment 3 - Chapters 7-8</h1>
<p class="subtitle lead">Time series analysis</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Maggie Burmeister </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">August 11, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="student-declaration" class="level2">
<h2 class="anchored" data-anchor-id="student-declaration">Student declaration</h2>
<p><strong><em>Instructions: Indicate that you understand and agree with the following three statements by typing an x in the square brackets below, e.g.&nbsp;[x].</em></strong></p>
<p>I declare that this assessment item is my own work, except where acknowledged, and has not been submitted for academic credit elsewhere or previously, or produced independently of this course (e.g.&nbsp;for a third party such as your place of employment) and acknowledge that the assessor of this item may, for the purpose of assessing this item: (i) Reproduce this assessment item and provide a copy to another member of the University; and/or (ii) Communicate a copy of this assessment item to a plagiarism checking service (which may then retain a copy of the assessment item on its database for the purpose of future plagiarism checking).</p>
<ul class="task-list">
<li><label><input type="checkbox" checked="">I understand and agree</label></li>
</ul>
<p>I certify that I have read and understood the University Rules in respect of Student Academic Misconduct.</p>
<ul class="task-list">
<li><label><input type="checkbox" checked="">I understand and agree</label></li>
</ul>
<p>I have a backup copy of the assessment.</p>
<ul class="task-list">
<li><label><input type="checkbox" checked="">I understand and agree</label></li>
</ul>
</section>
<section id="statement-on-the-use-of-generative-ai" class="level2">
<h2 class="anchored" data-anchor-id="statement-on-the-use-of-generative-ai">Statement on the use of generative AI</h2>
<p><strong><em>Instructions: If you have used Generative AI tools (e.g.&nbsp;ChatGPT, copilot, etc) to help complete this assessment, please state the details here. Your statement should include (i) the name of tool used; (ii) sections or questions that were answered with the help of generative AI; (iii) How generative AI was used. For example you might write “I used Microsoft Copilot to generate template R code for questions 1 and 2, and to help draft my written response to question 4.” If you have not used Generative AI to help complete your assessment, please state this.</em></strong></p>
</section>
<section id="section-1" class="level2">
<h2 class="anchored" data-anchor-id="section-1">Section 1</h2>
<section id="question-1" class="level3">
<h3 class="anchored" data-anchor-id="question-1">Question 1</h3>
<p>Describe the pre-intervention time series of total firearm deaths per 100,000 people (Figure 1a) in terms of trend and seasonality. Note the figure is easier to view in the pdf version of the article, as opposed to the online version.</p>
<p>The figure 1a showed a general declining trend from 1978 to 1996, as it is indicated by the overall downward slope of total firearm mortality rates. Although this decreasing trend was present even before the 1996 Australia firearm law intervention,it raises questions regarding the attribution of mortality reductions directly to the legislation. The authors mentioned that this decline may have been part of a pre-existing downward trend rather than solely due to the intervention itself. (As from the paper: They may simply capture a decreasing trend, or an acceleration of a decreasing trend in the firearm-related mortality rate that would have occurred even without the set of nationally implemented gun regulations).</p>
<p>Regarding seasonal patterns, I could not find that it was not descried in the figure or accompanying analysis.</p>
</section>
<section id="question-2" class="level3">
<h3 class="anchored" data-anchor-id="question-2">Question 2</h3>
<p>The authors propose a model that “takes the first difference of the data and estimates an ARIMA model of auto regressive order 1”. In your own words, summaries what it means and what the purpose of (i) taking the first difference and (ii) including an auto regressive order 1.</p>
<ol type="i">
<li><p>Taking the 1st difference: this step involves subtracting the value of the data point at one time period from the value at the previous period.As it mentioned in the paper, a standard method of removing a random walk is to convert a time series to first difference which mean converting the original time series data into a series of differences between consecutive observations. The purpose of this transformation is to remove random walk which drifts up and down in a non-consistent direction for long-term trend and make data stationary. This would help to stabilize the data, making it easier to identify patterns and relationships within the time series.</p></li>
<li><p>Including an auto regressive order 1: As it specified in the paper, one such pragmatic specification is the ARIMA model that allows the direct specification of the number of (lags) past periods which mean the current value of time series is affected by its immediately preceding value. The “order 1” suggested that the model uses one prior data point to predict the current value. This captures short-term dependencies in the data, helping to model patterns where the value at a given time is correlated with its recent past values, making predictions more precise and reflective of past behaviors.</p></li>
</ol>
</section>
<section id="question-3" class="level3">
<h3 class="anchored" data-anchor-id="question-3">Question 3</h3>
<p>In Table 3, the authors present the results of a robustness check for the ARIMA modelling results presented in Table 1. Explain in your own words (i) what is the role of the robustness check, (ii) how is it implemented, and (iii) what is the interpretation.</p>
<ol type="i">
<li><p>Role of the robustness check: The purpose of robustness check is to test whether the the ARIMA model used to analyze the data is appropriately specified and reliable. As it mentioned in the paper, the goal of the specification check is to test whether the model truly captures the causal effects of the 1996 Australian firearm law or it might produce invalid or misleading results due to underlying trends or other unrelated factors. The goal is to ensure that the model gives a valid answer.</p></li>
<li><p>How is it implemented: The robustness check include introducing “artificial” interventions in years prior to 1996 and testing the ARIMA model on these pre-intervention periods. In the Fig 1, beside Trends in firearm and pre and post artificial law implementations, the authors created hypothetical scenarios where the firearm law was enacted from 1990 to 1995, and then assessed whether the model would detect any significant changes in firearm mortality during those artificially years. If the model detects statistically significant effects in those years where no actual intervention occurred, it reveals that the model may capture trends unrelated to the law, therefore, raising concerns about its validity.</p></li>
<li><p>Interpretation: As in Table 3 showed the results of robustness check, when the ARIMA model is applied to those artificial intervention years, it leads to statistically insignificant effects on all firearm mortality types. This result suggests that the ARIMA model is appropriately specified and able to isolate the impact of the actual 1996 firearm law. On the other hand, if significant changes were detected during those artificial interventions, it would imply that the original findings could be influenced by factors other than the actual law, reducing the credibility of the causal claims.</p></li>
</ol>
</section>
</section>
<section id="section-2" class="level2">
<h2 class="anchored" data-anchor-id="section-2">Section 2</h2>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>    date  hom_rate
1 Jan-00 0.5732980
2 Feb-00 0.4611310
3 Mar-00 0.4486680
4 Apr-00 0.4798255
5 May-00 0.5732980
6 Jun-00 0.4362050</code></pre>
</div>
</div>
<section id="question-1-1" class="level3">
<h3 class="anchored" data-anchor-id="question-1-1">Question 1</h3>
<p>Create a plot of the homicide rate over time, as if you were preparing it for inclusion in a report or publication.</p>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'zoo'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    as.Date, as.Date.numeric</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.
ℹ Please use `linewidth` instead.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 11 rows containing missing values or values outside the scale range
(`geom_line()`).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="submission_files/figure-html/plot_hom_rate_with_trend_over_time-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'lubridate'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    date, intersect, setdiff, union</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="submission_files/figure-html/boxplot_over_time-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>      date               hom_rate       rolling_mean        month   
 Min.   :2000-01-01   Min.   :0.3139   Min.   :0.4511   Jan    : 8  
 1st Qu.:2001-12-24   1st Qu.:0.4593   1st Qu.:0.4844   Feb    : 8  
 Median :2003-12-16   Median :0.5016   Median :0.4943   Mar    : 8  
 Mean   :2003-12-16   Mean   :0.5116   Mean   :0.5069   Apr    : 8  
 3rd Qu.:2005-12-08   3rd Qu.:0.5585   3rd Qu.:0.5125   May    : 8  
 Max.   :2007-12-01   Max.   :0.7840   Max.   :0.6069   Jun    : 8  
                                       NA's   :11       (Other):48  </code></pre>
</div>
</div>
</section>
<section id="question-2-1" class="level3">
<h3 class="anchored" data-anchor-id="question-2-1">Question 2</h3>
<p>Describe the homicide rate time series in terms of the trend, seasonality, and outliers. Provide appropriate plots and summary statistics to support your statements. i) Trend: Look at the “Homicide Rate with Trend Over Time”, there is a general upward trend in the homicide rate over the observed time period. This suggests an increasing tendency in homicide rates over time. ii) Seasonality: The boxplot of homicide rates by month indicates some level of seasonality. For example, rates seems to be generally higher in Janurary and December, suggesting a possible seasonal increase during the winter months. iii) Outliers: The boxplot shows several outliers, particularly in months like February, March, April, July and October. The minimum and maximum values of the homicide rates also reveal occasional spikes or drops in the data.</p>
<p>Summary statistic of hom_rate - Mean: 0.5116 - SD: 0.0737 - Minimum: 0.3139 - Maximum: 0.7840 - Interquartile Range (IQR): Q1 = 0.4593, Q2 = 0.5016 and Q3 = 0.5585</p>
</section>
<section id="question-3-1" class="level3">
<h3 class="anchored" data-anchor-id="question-3-1">Question 3</h3>
<p>Estimate the effect of the stand-your-ground law using segmented regression and ARIMA. Comment on the fit/appropriateness of each model, and state which model you believe best describes the association between the intervention and the homicide rate over time.</p>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre><code>Installing package into 'C:/Users/maggi/AppData/Local/R/win-library/4.4'
(as 'lib' is unspecified)</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>package 'segmented' successfully unpacked and MD5 sums checked

The downloaded binary packages are in
    C:\Users\maggi\AppData\Local\Temp\RtmpKorjA2\downloaded_packages</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Installing package into 'C:/Users/maggi/AppData/Local/R/win-library/4.4'
(as 'lib' is unspecified)</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>package 'nlme' successfully unpacked and MD5 sums checked

The downloaded binary packages are in
    C:\Users\maggi\AppData\Local\Temp\RtmpKorjA2\downloaded_packages</code></pre>
</div>
</div>
<section id="segmented-regression" class="level4">
<h4 class="anchored" data-anchor-id="segmented-regression">Segmented Regression</h4>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'segmented' was built under R version 4.4.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: MASS</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: nlme</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'nlme' was built under R version 4.4.3</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = hom_rate ~ date_numeric + intervention + time_since_intervention, 
    data = df)

Residuals:
      Min        1Q    Median        3Q       Max 
-0.170306 -0.038642 -0.002372  0.030320  0.179965 

Coefficients:
                          Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)              6.144e-01  1.473e-01   4.171 6.87e-05 ***
date_numeric            -1.053e-05  1.227e-05  -0.858  0.39303    
intervention             4.230e-02  2.759e-02   1.533  0.12869    
time_since_intervention  1.435e-04  5.167e-05   2.777  0.00665 ** 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.06178 on 92 degrees of freedom
Multiple R-squared:  0.3202,    Adjusted R-squared:  0.298 
F-statistic: 14.45 on 3 and 92 DF,  p-value: 8.684e-08</code></pre>
</div>
</div>
</section>
<section id="arima-model" class="level4">
<h4 class="anchored" data-anchor-id="arima-model">ARIMA model</h4>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre><code>Installing package into 'C:/Users/maggi/AppData/Local/R/win-library/4.4'
(as 'lib' is unspecified)</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>package 'forecast' successfully unpacked and MD5 sums checked

The downloaded binary packages are in
    C:\Users\maggi\AppData\Local\Temp\RtmpKorjA2\downloaded_packages</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'forecast' was built under R version 4.4.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Registered S3 method overwritten by 'quantmod':
  method            from
  as.zoo.data.frame zoo </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'forecast'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:nlme':

    getResponse</code></pre>
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Series: df$hom_rate 
Regression with ARIMA(0,0,0) errors 

Coefficients:
      intercept    xreg
         0.4881  0.0837
s.e.     0.0076  0.0143

sigma^2 = 0.00405:  log likelihood = 129.23
AIC=-252.46   AICc=-252.19   BIC=-244.76

Training set error measures:
                       ME       RMSE        MAE       MPE     MAPE      MASE
Training set 1.179612e-16 0.06297228 0.04883892 -1.526208 9.725113 0.7209367
                   ACF1
Training set 0.08579671</code></pre>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="submission_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Ljung-Box test

data:  Residuals from Regression with ARIMA(0,0,0) errors
Q* = 4.3404, df = 10, p-value = 0.9307

Model df: 0.   Total lags used: 10</code></pre>
</div>
</div>
<ul>
<li>The top graph: In this graph, the residuals do not exhibit obvious trends or strong patterns, suggesting that the model’s errors are relatively random which is a good sign for model validity.</li>
<li>The ACF graph: It is easy to see that most of the auto correlations fall within the confidence range, indicating that there is minimal autocorrelation in the residuals. There are 2 spikes that exceed the range. Generally, the model capture the structure of data quite reasonably. If these spikes were numerous, it would suggest that the model might not good enough to capture all patterns of the data.</li>
<li>The histogram appear approximately normal distribution. The is a light skew from perfect normality, as indicated by the asymmetry or minor deviations from the bell curve shape.</li>
</ul>
</section>
<section id="compare-models" class="level4">
<h4 class="anchored" data-anchor-id="compare-models">Compare models</h4>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="submission_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>                        df       AIC
seg_model                5 -256.2220
arima_with_intervention  3 -252.4555</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                        df       BIC
seg_model                5 -243.4003
arima_with_intervention  3 -244.7624</code></pre>
</div>
</div>
</section>
</section>
<section id="question-4" class="level3">
<h3 class="anchored" data-anchor-id="question-4">Question 4</h3>
<p>Using the “best” model from question (3), summaries your findings and write a conclusion describing the impact of the law on the homicide rate in Florida. Provide effect estimates and relevant statistics to support your answer.</p>
<p>When we look at the graph comparison of Segmented Regression and ARIMA model plus the AIC values (the BIC values between 2 models are not much different), the Segmented Regression model is slightly better than ARIMA model.By looking at the graph, we can see that Segmented Regression model gives the upward trend from 2006 which is matched to the observed line while the ARIMA is plateaued. I will detail the summary of Segmented Regression model as below: - Intercept: The estimate for the intercept (0.6144) represents the expected homicide rate when all predictors variables are zero. The associated p-value (6.87e-05) suggests this coefficient is highly statistically significant. - date_numeric: the coefficient is very small (-1.0542-05) with a large p-value (0.39303) indicating that changes over time. It mean not statistically significant effect. - intervention: the coefficient (0.0423) for the intervention variable suggests a slightly increase in the homicide rate immediately following the intervention. However the p-value implying that this change is not statistically significant. - time_since_intervention: the coefficient suggests that for each unit increase in time since the intervention, there is a mild upward trend in the homicide rate. The p value shows that this effect is statistically significant at 1% level which means there is a notable effect overtime after the intervention. - R2 values is around 32% of the variance in the homicide rate is explained by the model. The adjusted R2 is slightly lower which mean if we add more predictors into the model, it would not improve the fit. -F-statistic and p-value suggests that the model is generally statistically significant, meaning that at least one of the predictors has a significant impact on the homicide rate.</p>
<p>In conclusion, the ‘time_since_intervention’ has a significant positive association with the homicide rate over time while ‘intervention’ and ‘date_numeric’ show no statistically significant.</p>
<p>Regarding to the result of analysis above, the stand-your-ground law in Florida did not show a statistically significant immediate change in the homicide rate upon its enactment. However, when we see the graph, the law was associated with a moderate increase in the homicide rate over time. This long-term upward trend suggests that the law may have contributed to environment with elevated risk of homicides.</p>
</section>
<section id="question-5" class="level3">
<h3 class="anchored" data-anchor-id="question-5">Question 5</h3>
<p>Including a negative control series is one way of improving causal inference from interrupted time series analysis. Give one example of a negative control series for this intervention (be specific), and justify your selection. Explain in your own words how a negative control series helps with inference.</p>
<p>Interrupted time series design is the strongest, quasi-experimental approach for evaluating longitudinal effect of interventions(paper “Segmented regression analysis of ITS studies in medical use research. However, the resulting estimates of intervention impact can be severely biased if the underlying trends are not adequately accounted for. Control series offer a potential solution to this problem, the control series should share the same confounders as the intervention series an be unaffected by the intervention(in the paper”Analyzing Interrupted Time Series with Control”).</p>
<p>For this question base on the stand-your-ground law in Florida, the negative control series for evaluating the impact of the law on homicide rates in Florida could be non-violate crime rates such as theft, fraud or drug-related crimes in Florida over the same time period. The reason for choosing non-violent crime rate is that the stand-your-ground law is primarily pertain to the use of lethal force in self-defense situations which involving interpersonal violence, and the non-violent crime rates opposites to this so it is unlikely to be directly affected by this law. If the observed trend in non-violent crimes remains stable, it provides evidence that any change in the homicide rate is more likely attributable to the intervention rather than other broader societal factors that may influence crime in general.</p>
<p>Negative control series helps improve causal inference by serving a baseline or reference point that is not expected to be affected by the intervention. It acts as a counter factual to strengthen the causal claim that changes observed in the primary outcome. In other words, it would help to rule out confounders. If the primary series and the negative control series share a similar pattern of change after the intervention, it suggests that external factors may be responsible for the observed trend. If only the primary shows a significant change post-intervention while the negative control remains stable, this strengthens the argument that the intervention has a specific effect on the primary outcome. In conclusion, a negative control series gives us a way to distinguish between changes caused by intervention and those different factors, improving the robustness and validity of causal claims in ITSA.</p>
<p>The segmented regression model and the control trend model can both be used to adjust for confounding; however, the latter is potentially more convincing between two models, but only if the control has a strong justification and is statistically consistent with the model. If in studies where no negative control is available or where the quality of negative control is in doubt, the segmented regression model may provide a useful alternative. (paper “Analyzing Interrupted Time Series with a Control)</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>